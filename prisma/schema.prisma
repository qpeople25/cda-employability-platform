// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  firstName String
  lastName  String
  role      String   // "admin" | "coach"
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Coach assignments
  assignedParticipants CoachAssignment[]
  sessions             Session[]
  auditLogs            AuditLog[]
}

model CoachAssignment {
  id            String   @id @default(cuid())
  coachId       String
  coach         User     @relation(fields: [coachId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  assignedAt    DateTime @default(now())
  assignedBy    String?  // Admin who made the assignment
  
  @@unique([coachId, participantId])
}

model Participant {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  gender    String
  dateOfBirth DateTime? // Optional to allow migration
  ageRange  String?   // Keep temporarily for migration
  education String
  emirate   String
  phone     String?
  email     String?
  
  // New static fields
  maritalStatus            String?  // "Single" | "Married" | "Divorced" | "Widowed"
  dependents               Int?     @default(0)
  nationalServiceCompleted Boolean? @default(false)
  peopleOfDetermination    Boolean? @default(false)
  conviction               Boolean? @default(false)
  drivingLicense           Boolean? @default(false)
  
  createdAt DateTime @default(now())

  sessions    Session[]
  barriers    Barrier[]
  assignments CoachAssignment[]
}

model Session {
  id            String   @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  coachId       String
  coach         User     @relation(fields: [coachId], references: [id])
  
  occurredAt    DateTime @default(now())
  sessionType   String   @default("baseline") // "baseline" | "follow_up"
  
  // FACTOR 1: Mindset & Motivation - Sub-Component Scores
  scoreMotivationToWork      Int?  // Desire to work, urgency, willingness to take action
  scoreMotivationConsistency Int?  // Ability to stay committed, overcome setbacks
  scoreMotivationOwnership   Int?  // Taking responsibility vs waiting for others
  
  // FACTOR 2: Career Awareness & Direction - Sub-Component Scores
  scoreCareerClarity         Int?  // Understanding what job they want
  scoreCareerSectorAwareness Int?  // Knowing available roles and industry expectations
  scoreCareerRoleFit         Int?  // Understanding day-to-day responsibilities
  
  // FACTOR 3: Job Search Skills & Application - Sub-Component Scores
  scoreSearchApplicationSkills Int?  // Ability to find, select, and apply properly
  scoreSearchInterviewReadiness Int? // Preparedness and confidence in interactions
  scoreSearchStrategy          Int?  // Consistency, methods, quality of practice
  
  // FACTOR 4: Employability & Workplace Skills - Sub-Component Scores
  scoreEmployabilityCommunication Int?  // English & communication skills
  scoreEmployabilityDigitalSkills Int?  // Microsoft Office, email, systems
  scoreEmployabilityWorkplace     Int?  // Punctuality, teamwork, following instructions
  
  // FACTOR 5: Personal Development - Sub-Component Scores
  scoreLearningAwareness    Int?  // Understanding strengths, weaknesses, improvement areas
  scoreLearningGrowthMindset Int? // Openness to feedback and training
  scoreLearningGoalSetting   Int? // Ability to set and follow goals
  
  // FACTOR 6: Financial Independence - Sub-Component Scores
  scoreFinancialPressure      Int?  // Urgency to work due to obligations
  scoreFinancialExpectations  Int?  // Salary expectations vs market reality
  scoreFinancialFlexibility   Int?  // Accepting entry-level opportunities
  
  // FACTOR 7: Confidence & Self-Management - Sub-Component Scores
  scoreResilienceConfidence      Int?  // Self-confidence in employment settings
  scoreResilienceStressManagement Int? // Handling setbacks, pressure, unfamiliar environments
  scoreResilienceIndependence    Int?  // Managing time, tasks, expectations independently
  
  // FACTOR 8: Social Support & Environment - Sub-Component Scores
  scoreSupportFamilyApproval Int?  // Family approval, especially private sector
  scoreSupportCultural       Int?  // Environmental or cultural constraints
  scoreSupportSystem         Int?  // Childcare, transportation, social network
  
  // Coach notes per factor (overall notes, not per sub-component)
  notesMotivation     String
  notesCareer         String
  notesSearch         String
  notesEmployability  String
  notesLearning       String
  notesFinancial      String
  notesResilience     String
  notesSupport        String
  
  // Computed fields
  readinessIndex    Int    // Sum of 24 sub-component scores (max: 168, min: 24)
  readinessCategory String // "A" (126+) | "B" (84-125) | "C" (0-83)
  
  // Optional fields
  nextTouchpoint    DateTime?
  notes             String?
  consentObtained   Boolean   @default(false)
  
  // Goals (simple text for MVP)
  shortTermGoal1    String?
  shortTermGoal2    String?
  longTermGoal      String?
  
  // NEW: Tab 2 - Motivation & Mindset
  dateLastEmployment DateTime?
  
  // NEW: Tab 3 - Career Development
  targetSector1      String?
  targetSector2      String?
  targetSector3      String?
  preferredJobRole   String?
  jobTypePreference  String? // "Full-time" | "Part-time" | "Contract" | "Flexible"
  salaryMin          Int?
  salaryMax          Int?
  preferredLocation  String? // "Dubai" | "Abu Dhabi" | "Sharjah" | "Remote" | "Flexible"
  
  // NEW: Tab 4 - Job Search Skills
  cvStatus           String? // "No CV" | "Needs Update" | "Ready" | "Professional"
  linkedInStatus     String? // "No Profile" | "Incomplete" | "Complete" | "Optimized"
  jobApplicationsCount Int?
  
  // NEW: Tab 5 - Employability Skills
  englishProficiency String? // "Basic" | "Intermediate" | "Advanced" | "Fluent"
  arabicProficiency  String? // "Native" | "Fluent" | "Intermediate" | "Basic" | "None"
  
  // NEW: Tab 6 - Continuous Learning
  developmentInterests String?
  
  // NEW: Tab 8 - Resilience & Wellbeing
  confidenceEmployment String? // "Very Low" | "Low" | "Moderate" | "High" | "Very High"
  optimismFuture       String? // "Pessimistic" | "Uncertain" | "Cautiously Optimistic" | "Very Optimistic"
  
  // NEW: Tab 9 - Support Network
  childcareArrangements String? // "In place" | "Needed" | "Not applicable"
  transportationAccess  String? // "Own car" | "Public transport" | "Family support" | "None" | "Need assistance"
  scheduleConstraints   String?
  familySupport         String? // "Very supportive" | "Supportive" | "Neutral" | "Not supportive"
  communityResources    String?
  
  // NEW: Tab 10 - Plan Summary
  coachRecommendations  String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  barriers          Barrier[]
}

model BarrierBank {
  id              String   @id @default(cuid())
  code            String   @unique
  label           String
  category        String
  description     String?
  defaultSeverity String   @default("Medium") // "High" | "Medium" | "Low"
  dimension       String?  // Can be one of the 8 domains or null
  active          Boolean  @default(true)
  
  barriers        Barrier[]
}

model Barrier {
  id            String   @id @default(cuid())
  sessionId     String
  session       Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  barrierBankId String
  barrierBank   BarrierBank @relation(fields: [barrierBankId], references: [id])
  
  severity      String   // "High" | "Medium" | "Low"
  source        String   // "auto" | "manual"
  dimension     String?  // One of the 8 domains or null
  notes         String?
  status        String   @default("active") // "active" | "resolved"
  
  createdAt     DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  userEmail     String
  userRole      String
  action        String   // "create", "update", "delete"
  entityType    String   // "participant", "session", "barrier"
  entityId      String
  changes       String?  // JSON string of what changed
  timestamp     DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
}
