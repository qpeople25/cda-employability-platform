// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  firstName String
  lastName  String
  role      String   // "admin" | "coach"
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Coach assignments
  assignedParticipants CoachAssignment[]
  sessions             Session[]
  auditLogs            AuditLog[]
}

model CoachAssignment {
  id            String   @id @default(cuid())
  coachId       String
  coach         User     @relation(fields: [coachId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  assignedAt    DateTime @default(now())
  assignedBy    String?  // Admin who made the assignment
  
  @@unique([coachId, participantId])
}

model Participant {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  gender    String
  ageRange  String
  education String
  emirate   String
  phone     String?
  email     String?
  
  // New static fields
  maritalStatus            String?  // "Single" | "Married" | "Divorced" | "Widowed"
  dependents               Int?     @default(0)
  nationalServiceCompleted Boolean? @default(false)
  peopleOfDetermination    Boolean? @default(false)
  conviction               Boolean? @default(false)
  drivingLicense           Boolean? @default(false)
  
  createdAt DateTime @default(now())

  sessions    Session[]
  barriers    Barrier[]
  assignments CoachAssignment[]
}

model Session {
  id            String   @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  coachId       String
  coach         User     @relation(fields: [coachId], references: [id])
  
  occurredAt    DateTime @default(now())
  sessionType   String   @default("baseline") // "baseline" | "follow_up"
  
  // Coach scores (1-7)
  scoreMotivation     Int
  scoreCareer         Int
  scoreSearch         Int
  scoreEmployability  Int
  scoreLearning       Int
  scoreFinancial      Int
  scoreResilience     Int
  scoreSupport        Int
  
  // Coach notes per domain
  notesMotivation     String
  notesCareer         String
  notesSearch         String
  notesEmployability  String
  notesLearning       String
  notesFinancial      String
  notesResilience     String
  notesSupport        String
  
  // Computed fields
  readinessIndex    Int
  readinessCategory String // "A" | "B" | "C"
  
  // Optional fields
  nextTouchpoint    DateTime?
  notes             String?
  consentObtained   Boolean   @default(false)
  
  // Goals (simple text for MVP)
  shortTermGoal1    String?
  shortTermGoal2    String?
  longTermGoal      String?
  
  // NEW: Tab 2 - Motivation & Mindset
  dateLastEmployment DateTime?
  
  // NEW: Tab 3 - Career Development
  targetSector1      String?
  targetSector2      String?
  targetSector3      String?
  preferredJobRole   String?
  jobTypePreference  String? // "Full-time" | "Part-time" | "Contract" | "Flexible"
  salaryMin          Int?
  salaryMax          Int?
  preferredLocation  String? // "Dubai" | "Abu Dhabi" | "Sharjah" | "Remote" | "Flexible"
  
  // NEW: Tab 4 - Job Search Skills
  cvStatus           String? // "No CV" | "Needs Update" | "Ready" | "Professional"
  linkedInStatus     String? // "No Profile" | "Incomplete" | "Complete" | "Optimized"
  jobApplicationsCount Int?
  
  // NEW: Tab 5 - Employability Skills
  englishProficiency String? // "Basic" | "Intermediate" | "Advanced" | "Fluent"
  arabicProficiency  String? // "Native" | "Fluent" | "Intermediate" | "Basic" | "None"
  
  // NEW: Tab 6 - Continuous Learning
  developmentInterests String?
  
  // NEW: Tab 8 - Resilience & Wellbeing
  confidenceEmployment String? // "Very Low" | "Low" | "Moderate" | "High" | "Very High"
  optimismFuture       String? // "Pessimistic" | "Uncertain" | "Cautiously Optimistic" | "Very Optimistic"
  
  // NEW: Tab 9 - Support Network
  childcareArrangements String? // "In place" | "Needed" | "Not applicable"
  transportationAccess  String? // "Own car" | "Public transport" | "Family support" | "None" | "Need assistance"
  scheduleConstraints   String?
  familySupport         String? // "Very supportive" | "Supportive" | "Neutral" | "Not supportive"
  communityResources    String?
  
  // NEW: Tab 10 - Plan Summary
  coachRecommendations  String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  barriers          Barrier[]
}

model BarrierBank {
  id              String   @id @default(cuid())
  code            String   @unique
  label           String
  category        String
  description     String?
  defaultSeverity String   @default("Medium") // "High" | "Medium" | "Low"
  dimension       String?  // Can be one of the 8 domains or null
  active          Boolean  @default(true)
  
  barriers        Barrier[]
}

model Barrier {
  id            String   @id @default(cuid())
  sessionId     String
  session       Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  barrierBankId String
  barrierBank   BarrierBank @relation(fields: [barrierBankId], references: [id])
  
  severity      String   // "High" | "Medium" | "Low"
  source        String   // "auto" | "manual"
  dimension     String?  // One of the 8 domains or null
  notes         String?
  status        String   @default("active") // "active" | "resolved"
  
  createdAt     DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  userEmail     String
  userRole      String
  action        String   // "create", "update", "delete"
  entityType    String   // "participant", "session", "barrier"
  entityId      String
  changes       String?  // JSON string of what changed
  timestamp     DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
}
